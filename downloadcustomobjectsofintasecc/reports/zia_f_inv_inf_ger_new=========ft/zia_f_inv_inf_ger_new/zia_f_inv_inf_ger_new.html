<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html>
<head>
<title>ZIA_F_INV_INF_GER_NEW</title>
</head>
<body bgcolor="#FFFFE0">
<font size="3" face = "Arial" color="#000000"><b>Code listing for function: ZIA_F_INV_INF_GER_NEW</b></font>
<br>
<font size="3" face = "Arial" color="#000000"><b>Description:  Invoice Delivery Function Module</b></font>
<hr>
<pre width="100">
FUNCTION ZIA_F_INV_INF_GER_NEW.
<font color ="#0000FF">*"----------------------------------------------------------------------</font>
<font color ="#0000FF">*"*"Local Interface:</font>
<font color ="#0000FF">*"  TABLES</font>
<font color ="#0000FF">*"      IT_CS TYPE  ZIA_T_SO_INV_H_NEW</font>
<font color ="#0000FF">*"      TT_CS TYPE  ZIA_T_SO_INV_ITEM</font>
<font color ="#0000FF">*"      IT_DISC TYPE  ZIA_T_FREIGHT_VAL</font>
<font color ="#0000FF">*"----------------------------------------------------------------------</font>

<font color ="#0000FF">*       <a href ="global-zia_f_inv_inf_ger_new.html">Global data declarations</a></font>


  TABLES: ZIA_CS_FROM_FTP, ZIA_PILOG.

  DATA:WA_CS TYPE ZIA_S_SO_INV_I.

  DATA : P_PLANT TYPE WERKS.
  DATA : FLG_R TYPE I.
  DATA : RECEXIST TYPE C.
  DATA : LV_TR_DATE TYPE SY-DATUM.
  DATA : LV_SRNO(8)      TYPE N,
         LV_MESSAGE(200) TYPE C,
         LV_COUNT(5)     TYPE C,
         V_BUKRS         TYPE T001K-BUKRS,
         TEXT1(5)        TYPE C,
         TEXT2(10)       TYPE C.
  DATA : IT_ERR_MSG TYPE TABLE OF ZIA_S_RES_PNS,
         WA_ERR_MSG TYPE ZIA_S_RES_PNS.
  DATA : ZSAP_PARAM2 TYPE ZIA_FTP-SAP_PARAM2.

  DATA : V_TEXT(255) TYPE C,
         V_CHAR1(30) TYPE C,
         V_CHAR2(30) TYPE C,
         V_CHAR3(30) TYPE C.
  DATA:  V_MATERIAL TYPE MARA-MATNR.

  DATA: IT_ZIA_T_SO_CONF TYPE TABLE OF ZIA_T_SO_CONF,
        WA_ZIA_T_SO_CONF TYPE ZIA_T_SO_CONF.
  DATA: IT_ZIA_T_SO_CONF_I TYPE TABLE OF ZIA_T_SO_CONF_I,
        WA_ZIA_T_SO_CONF_I TYPE ZIA_T_SO_CONF_I.

  TYPES: BEGIN OF TY_PARAM,
           TH_PARAM   TYPE ZIA_FTP-TH_PARAM,
           SAP_PARAM  TYPE ZIA_FTP-SAP_PARAM,
           SAP_PARAM2 TYPE ZIA_FTP-SAP_PARAM2,
         END OF TY_PARAM.

  DATA : LT_PARAM  TYPE TABLE OF TY_PARAM,
         LWA_PARAM TYPE TY_PARAM.
  DATA : LT_PARAM1  TYPE TABLE OF TY_PARAM,
         LWA_PARAM1 TYPE TY_PARAM.
  DATA : LT_PARAM2  TYPE TABLE OF TY_PARAM,
         LWA_PARAM2 TYPE TY_PARAM.
  DATA : LT_PARAM3  TYPE TABLE OF TY_PARAM,
         LWA_PARAM3 TYPE TY_PARAM.
  DATA : LT_PARAM4  TYPE TABLE OF TY_PARAM,
         LWA_PARAM4 TYPE TY_PARAM.

  TYPES: I_AUFTRAGSNUMMER TYPE RANGE OF ZIA_S_SO_INV_H-AUFTRAGSNUMMER.
  DATA : IT_AUFTRAGSNUMMER TYPE I_AUFTRAGSNUMMER,
         WA_AUFTRAGSNUMMER TYPE LINE OF I_AUFTRAGSNUMMER.

  TYPES: I_AUFTRAGGEBER TYPE RANGE OF ZIA_S_SO_INV_H-AUFTRAGGEBER.
  DATA : IT_AUFTRAGGEBER TYPE I_AUFTRAGGEBER,
         WA_AUFTRAGGEBER TYPE LINE OF I_AUFTRAGGEBER.
  TYPES: I_AUFTRAGSART TYPE RANGE OF ZIA_S_SO_INV_H-AUFTRAGSART.
  DATA : IT_AUFTRAGSART TYPE I_AUFTRAGSART,
         WA_AUFTRAGSART TYPE LINE OF I_AUFTRAGSART.
  TYPES: I_MATNR TYPE RANGE OF ZIA_S_SO_INV_I-MATNR.
  DATA : IT_MATNR TYPE I_MATNR,
         WA_MATNR TYPE LINE OF I_MATNR.

  TYPES: I_KUNDENGRUPPEID TYPE RANGE OF ZIA_S_SO_INV_H-KUNDENGRUPPEID.
  DATA : IT_KUNDENGRUPPEID TYPE I_KUNDENGRUPPEID,
         WA_KUNDENGRUPPEID TYPE LINE OF I_KUNDENGRUPPEID.

  DATA : IT_KUNDENGRUPPEID1 TYPE I_KUNDENGRUPPEID,
         WA_KUNDENGRUPPEID1 TYPE LINE OF I_KUNDENGRUPPEID.

  TYPES: I_ZAHLUNGSBED TYPE RANGE OF ZIA_S_SO_INV_H-ZAHLUNGSBED.
  DATA : IT_ZAHLUNGSBED TYPE I_ZAHLUNGSBED,
         WA_ZAHLUNGSBED TYPE LINE OF I_ZAHLUNGSBED.

  TYPES: I_REASON_CODE TYPE RANGE OF ZIA_S_SO_INV_H-REASON_CODE.
  DATA : IT_REASON_CODE TYPE I_REASON_CODE,
         WA_REASON_CODE TYPE LINE OF I_REASON_CODE.

  DATA: LANGTH TYPE I,
        POS(2) TYPE N.

<font color ="#0000FF">*--------------------------------------------------------------------*</font>

  TYPES: BEGIN OF TY_UPID_LOCSKU,
           FGEX       TYPE ZAN_UPID_LOCSKU-FGEX,
           WHPLANT    TYPE ZAN_UPID_LOCSKU-WHPLANT,
           LOCALMATNR TYPE ZAN_UPID_LOCSKU-LOCALMATNR,
           CREATEDON  TYPE ZAN_UPID_LOCSKU-CREATEDON,
         END OF TY_UPID_LOCSKU.

  TYPES: BEGIN OF TY_MCHA,
           MATNR TYPE MCHA-MATNR,
           WERKS TYPE MCHA-WERKS,
           CHARG TYPE MCHA-CHARG,
         END OF TY_MCHA.

  DATA: IT_UPID_LOCSKU TYPE TABLE OF TY_UPID_LOCSKU,
        WA_UPID_LOCSKU TYPE TY_UPID_LOCSKU.

  DATA: IT_MCHA TYPE TABLE OF TY_MCHA,
        WA_MCHA TYPE TY_MCHA.

  DATA: V_COUNT TYPE I.

<font color ="#0000FF">*--------------------------------------------------------------------*</font>

  LOOP AT IT_CS.

    WA_AUFTRAGSNUMMER-SIGN = 'I'.
    WA_AUFTRAGSNUMMER-OPTION = 'EQ'.
    WA_AUFTRAGSNUMMER-LOW = IT_CS-AUFTRAGSNUMMER.
    APPEND WA_AUFTRAGSNUMMER TO IT_AUFTRAGSNUMMER.
    CLEAR:WA_AUFTRAGSNUMMER.

    WA_ZAHLUNGSBED-SIGN = 'I'.
    WA_ZAHLUNGSBED-OPTION = 'EQ'.
    WA_ZAHLUNGSBED-LOW = IT_CS-ZAHLUNGSBED.
    APPEND WA_ZAHLUNGSBED TO IT_ZAHLUNGSBED.
    CLEAR:WA_ZAHLUNGSBED.

    WA_AUFTRAGGEBER-SIGN = 'I'.
    WA_AUFTRAGGEBER-OPTION = 'EQ'.
    WA_AUFTRAGGEBER-LOW = IT_CS-AUFTRAGGEBER.
    APPEND WA_AUFTRAGGEBER TO IT_AUFTRAGGEBER.
    CLEAR:WA_AUFTRAGGEBER.

    WA_KUNDENGRUPPEID-SIGN = 'I'.
    WA_KUNDENGRUPPEID-OPTION = 'EQ'.
    WA_KUNDENGRUPPEID-LOW = IT_CS-KUNDENGRUPPEID.
    APPEND WA_KUNDENGRUPPEID TO IT_KUNDENGRUPPEID.
    CLEAR:WA_KUNDENGRUPPEID.

    WA_REASON_CODE-SIGN = 'I'.
    WA_REASON_CODE-OPTION = 'EQ'.
    TRANSLATE IT_CS-GUTSCHRIFTSGRUND TO UPPER CASE.
    CLEAR: LANGTH, POS.
    LANGTH = STRLEN( IT_CS-GUTSCHRIFTSGRUND ).

    DO LANGTH TIMES.

      IF IT_CS-GUTSCHRIFTSGRUND+POS(1) CO '01123456789./'.
        CLEAR IT_CS-GUTSCHRIFTSGRUND+POS(1).
      ENDIF.
      ADD 1 TO POS.
    ENDDO.

    CONDENSE IT_CS-GUTSCHRIFTSGRUND NO-GAPS.
    WA_REASON_CODE-LOW = IT_CS-GUTSCHRIFTSGRUND.
    APPEND WA_REASON_CODE TO IT_REASON_CODE.
    CLEAR:WA_REASON_CODE.

    WA_AUFTRAGSART-SIGN = 'I'.
    WA_AUFTRAGSART-OPTION = 'EQ'.
    WA_AUFTRAGSART-LOW = IT_CS-AUFTRAGSART.
    APPEND WA_AUFTRAGSART TO IT_AUFTRAGSART.
    CLEAR:WA_AUFTRAGSART.

  ENDLOOP.
  IF IT_AUFTRAGSNUMMER[] IS NOT INITIAL.
    SELECT * FROM ZIA_T_SO_CONF INTO CORRESPONDING FIELDS OF TABLE IT_ZIA_T_SO_CONF  WHERE AUFTRAGNR IN IT_AUFTRAGSNUMMER.
<font color ="#0000FF">*  SELECT * FROM ZIA_T_SO_CONF INTO CORRESPONDING FIELDS OF TABLE IT_ZIA_T_SO_CONF  WHERE AUFTRAGNR IN IT_AUFTRAGGEBER.</font>
    SELECT * FROM ZIA_T_SO_CONF_I INTO CORRESPONDING FIELDS OF TABLE IT_ZIA_T_SO_CONF_I WHERE AUFTRAGNR IN IT_AUFTRAGSNUMMER.
<font color ="#0000FF">*  SELECT * FROM ZIA_T_SO_CONF_I INTO CORRESPONDING FIELDS OF TABLE IT_ZIA_T_SO_CONF_I FOR ALL ENTRIES IN IT_ZIA_T_SO_CONF</font>
<font color ="#0000FF">*                                                                                      WHERE AUFTRAGNR = IT_ZIA_T_SO_CONF-AUFTRAGNR.</font>
  ENDIF.

  SELECT TH_PARAM SAP_PARAM SAP_PARAM2 FROM ZIA_FTP INTO TABLE LT_PARAM  WHERE TH_PARAM IN  IT_AUFTRAGSART AND PROCESS_TYPE = 'DE_ORD_TYPE'.

  SELECT TH_PARAM SAP_PARAM SAP_PARAM2 FROM ZIA_FTP INTO TABLE LT_PARAM4  WHERE TH_PARAM IN  IT_REASON_CODE AND PROCESS_TYPE = 'DE_ORD_REA'.

<font color ="#0000FF">*  SELECT TH_PARAM SAP_PARAM SAP_PARAM2 FROM ZIA_FTP INTO TABLE LT_PARAM1  WHERE TH_PARAM IN IT_KUNDENGRUPPEID AND PROCESS_TYPE = 'DE_PRO_TYPE'.</font>
  SELECT TH_PARAM SAP_PARAM SAP_PARAM2 FROM ZIA_FTP INTO TABLE LT_PARAM2  WHERE TH_PARAM IN IT_KUNDENGRUPPEID AND PROCESS_TYPE = 'DE_CUST_GRP'.
<font color ="#0000FF">*  SELECT TH_PARAM SAP_PARAM SAP_PARAM2 FROM ZIA_FTP INTO TABLE LT_PARAM2  WHERE TH_PARAM IN IT_KUNDENGRUPPEID AND PROCESS_TYPE = 'DE_CUST_GRP'.</font>
<font color ="#0000FF">*  SELECT TH_PARAM SAP_PARAM SAP_PARAM2 FROM ZIA_FTP INTO TABLE LT_PARAM2  WHERE TH_PARAM IN IT_KUNDENGRUPPEID AND PROCESS_TYPE = 'DE_DISH_CHA'.</font>
<font color ="#0000FF">*  ZAHLUNGSBED</font>
  SELECT TH_PARAM SAP_PARAM SAP_PARAM2 FROM ZIA_FTP INTO TABLE LT_PARAM3  WHERE TH_PARAM IN IT_ZAHLUNGSBED AND PROCESS_TYPE = 'DE_PAY_TERMS'.

  SORT IT_CS BY BUCHUNGSDATUM AUFTRAGSNUMMER.

  LOOP AT IT_CS.
    AT NEW AUFTRAGSNUMMER.
      FLG_R = 1.
    ENDAT.

    CLEAR: RECEXIST.

    IF IT_CS-MANDT = '079'.
      P_PLANT = 'DE11'.
    ELSEIF IT_CS-MANDT = '080'.
      P_PLANT = 'NL13'.
    ENDIF.

    SELECT  SINGLE * FROM ZIA_CS_FROM_FTP WHERE TX_DATE = IT_CS-BUCHUNGSDATUM AND TX_NO = IT_CS-AUFTRAGSNUMMER AND DELIVERY_PLANT = P_PLANT.

    IF SY-SUBRC EQ 0.
      RECEXIST = 'X'.
      DELETE IT_CS.
    ENDIF.

    IF RECEXIST = 'X' AND FLG_R = 1.
      CONCATENATE IT_CS-BUCHUNGSDATUM+6(4) IT_CS-BUCHUNGSDATUM+3(2) IT_CS-BUCHUNGSDATUM+0(2) INTO LV_TR_DATE.
<font color ="#0000FF">*      READ TABLE IT_PARAM INTO WA_PARAM WITH KEY</font>
<font color ="#0000FF">*      ZIA_PILOG-PROCESS_TYPE   = GIT_CS-PROCESS_TYPE.</font>
      ZIA_PILOG-DOC_NO         = IT_CS-AUFTRAGSNUMMER.
      ZIA_PILOG-TX_DATE        = LV_TR_DATE.
<font color ="#0000FF">*      ZIA_PILOG-DISPATCH_NOTE  = GIT_CS-DISPATCH_NOTE.</font>
<font color ="#0000FF">*      ZIA_PILOG-REFERENCE_NO   = GIT_CS-CUST_PO_NO.</font>
      ZIA_PILOG-PLANT          = P_PLANT.
      ZIA_PILOG-STATUS         = 'E'.
      ZIA_PILOG-CREATED_ON     = SY-DATUM.
      ZIA_PILOG-TIME           = SY-UZEIT.
      ZIA_PILOG-CREATED_BY     = SY-UNAME.
<font color ="#0000FF">*      ZIA_PILOG-FILENAME       = GIT_CS-FILENAME.</font>

      CLEAR: LV_SRNO.
      SELECT SINGLE MAX( SR_NO ) INTO LV_SRNO FROM ZIA_PILOG.

      LV_SRNO = LV_SRNO + 1.
      ZIA_PILOG-SR_NO          = LV_SRNO.
      ZIA_PILOG-MESSAGE        = 'Record with same key already Exists'.
      INSERT ZIA_PILOG.
      COMMIT WORK.

      WA_ERR_MSG-DOCNO = IT_CS-AUFTRAGSNUMMER.
      WA_ERR_MSG-MESSAGE = 'Record with same key already Exists'.
      APPEND WA_ERR_MSG TO IT_ERR_MSG.
      CLEAR: LV_SRNO, ZIA_PILOG, WA_ERR_MSG, V_TEXT.

<font color ="#0000FF">**** END, IF ERROR THEN SAVE TO PILOG AND EMAIL</font>
    ENDIF.

    RECEXIST = ''.
    FLG_R = 0.
  ENDLOOP.

  LOOP AT IT_CS.

    SHIFT IT_CS-DEBITORKONTO LEFT DELETING LEADING '0'.
    SHIFT IT_CS-AADRESSNR LEFT DELETING LEADING '0'.
    SHIFT IT_CS-LADRESSNR LEFT DELETING LEADING '0'.
    SHIFT IT_CS-RADRESSNR LEFT DELETING LEADING '0'.

    CLEAR: LV_TR_DATE,ZIA_CS_FROM_FTP.
<font color ="#0000FF">*    CLEAR: WA_ZIA_T_SO_CONF.</font>

<font color ="#0000FF">*    READ TABLE IT_ZIA_T_SO_CONF INTO WA_ZIA_T_SO_CONF WITH KEY AUFTRAGNR = IT_CS-AUFTRAGSNUMMER.</font>
<font color ="#0000FF">*    READ TABLE IT_ZIA_T_SO_CONF INTO WA_ZIA_T_SO_CONF WITH KEY AUFTRAGNR = IT_CS-AUFTRAGGEBER.</font>

<font color ="#0000FF">*    READ TABLE IT_ZIA_T_SO_CONF_I INTO WA_ZIA_T_SO_CONF_I WITH KEY AUFTRAGNR = IT_CS-AUFTRAGGEBER.</font>

    ZIA_CS_FROM_FTP-TX_DATE            = IT_CS-BUCHUNGSDATUM.         "Date of invoicing
    ZIA_CS_FROM_FTP-TX_NO              = IT_CS-AUFTRAGSNUMMER.        "Unique invoice number
    ZIA_CS_FROM_FTP-DELIVERY_PLANT     = P_PLANT.
    " For Order Type
    CLEAR:LWA_PARAM.
    READ TABLE LT_PARAM INTO LWA_PARAM WITH KEY TH_PARAM = IT_CS-AUFTRAGSART.
    ZIA_CS_FROM_FTP-ORDER_TYPE         = LWA_PARAM-SAP_PARAM.

    " For Process type
<font color ="#0000FF">*    CLEAR:LWA_PARAM1.</font>
<font color ="#0000FF">*    READ TABLE LT_PARAM1 INTO LWA_PARAM1 INDEX  '1'.</font>
    ZIA_CS_FROM_FTP-PROCESS_TYPE = LWA_PARAM-SAP_PARAM2.
<font color ="#0000FF">*    ZIA_CS_FROM_FTP-PROCESS_TYPE = LWA_PARAM1-SAP_PARAM2.</font>
    " For Dist Channel
    CLEAR:LWA_PARAM2.
    READ TABLE LT_PARAM2 INTO LWA_PARAM2 WITH KEY TH_PARAM = IT_CS-KUNDENGRUPPEID.
    ZIA_CS_FROM_FTP-DIST_CHANNEL = LWA_PARAM2-SAP_PARAM.
    ZIA_CS_FROM_FTP-DIVISION     = '19'.
<font color ="#0000FF">*    ZIA_CS_FROM_FTP-SALES_GROUP = .</font>
<font color ="#0000FF">*    ZIA_CS_FROM_FTP-SALES_OFFICE = .</font>
    ZIA_CS_FROM_FTP-CURRENCY     = 'EUR'.
    IF IT_CS-AUFTRAGSART = '1' OR
<font color ="#0000FF">*      IT_CS-AUFTRAGSART = '12' OR</font>
      IT_CS-AUFTRAGSART = '2' OR IT_CS-AUFTRAGSART = '30'
      OR IT_CS-AUFTRAGSART = '31'
<font color ="#0000FF">*      OR IT_CS-AUFTRAGSART = '32'OR IT_CS-AUFTRAGSART =  '33'</font>
      OR IT_CS-AUFTRAGSART =  '34'.
<font color ="#0000FF">*    IF IT_CS-AUFTRAGSART &lt;&gt; '20'.</font>
<font color ="#0000FF">*    IF ZIA_CS_FROM_FTP-ORDER_TYPE &lt;&gt; 'ZEUC'.</font>
      DATA:V_RADRESSNR TYPE KNA1-KUNNR.
      CLEAR:V_RADRESSNR.

      V_RADRESSNR = IT_CS-RADRESSNR.
<font color ="#0000FF">*      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'</font>
<font color ="#0000FF">*        EXPORTING</font>
<font color ="#0000FF">*          INPUT  = WA_ZIA_T_SO_CONF-RADRESSNR</font>
<font color ="#0000FF">*        IMPORTING</font>
<font color ="#0000FF">*          OUTPUT = V_RADRESSNR.</font>

      ZIA_CS_FROM_FTP-BILL_TO_PARTY       = V_RADRESSNR.                    " Sold To party
      ZIA_CS_FROM_FTP-NAME_BILL_TO_PARTY  = IT_CS-RNAME1.
      ZIA_CS_FROM_FTP-SOLD_TO_PARTY       = IT_CS-AADRESSNR.     " Sold To party
      ZIA_CS_FROM_FTP-NAME_SOLD_TO_PARTY  = IT_CS-ANAME1.        " Name of solt to party
      ZIA_CS_FROM_FTP-PAYER = IT_CS-DEBITORKONTO.
      DATA:V_LADRESSNR TYPE KNA1-KUNNR.
      CLEAR:V_LADRESSNR.
      V_LADRESSNR = IT_CS-LADRESSNR.
<font color ="#0000FF">*      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'</font>
<font color ="#0000FF">*        EXPORTING</font>
<font color ="#0000FF">*          INPUT  = WA_ZIA_T_SO_CONF-LADRESSNR</font>
<font color ="#0000FF">*        IMPORTING</font>
<font color ="#0000FF">*          OUTPUT = V_LADRESSNR.</font>

      IF IT_CS-AUFTRAGSART = '20' OR IT_CS-AUFTRAGSART = '23' OR
         IT_CS-AUFTRAGSART = '24' OR IT_CS-AUFTRAGSART = '26' OR
         IT_CS-AUFTRAGSART = '12' OR IT_CS-AUFTRAGSART = '32' OR
         IT_CS-AUFTRAGSART = '33'.

        ZIA_CS_FROM_FTP-SHIP_TO_PARTY       = IT_CS-AADRESSNR.             " Sold To party
        ZIA_CS_FROM_FTP-NAME_SHIP_TO_PARTY  = IT_CS-ANAME1.                " Name of solt to party

      ELSE.

        ZIA_CS_FROM_FTP-SHIP_TO_PARTY       = V_LADRESSNR.                            " Ship to party
<font color ="#0000FF">*    ZIA_CS_FROM_FTP-SHIP_TO_PARTY       = WA_ZIA_T_SO_CONF-LADRESSNR.                " Ship to party</font>
        ZIA_CS_FROM_FTP-NAME_SHIP_TO_PARTY  = IT_CS-LNAME1.                " Name of ship to party
      ENDIF.
    ELSE.
      SHIFT IT_CS-AADRESSNR LEFT DELETING LEADING '0'.
      SHIFT IT_CS-RADRESSNR LEFT DELETING LEADING '0'.
      SHIFT IT_CS-DEBITORKONTO LEFT DELETING LEADING '0'.
      SHIFT IT_CS-AADRESSNR LEFT DELETING LEADING '0'.

<font color ="#0000FF">*      &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</font>
      ZIA_CS_FROM_FTP-ADD_FIELD3 = IT_CS-AUFTRAGGEBER.
      DATA:V_RADRESSNR4 TYPE KNA1-KUNNR.
      CLEAR:V_RADRESSNR4.
      V_RADRESSNR4 = IT_CS-AADRESSNR.

      ZIA_CS_FROM_FTP-SOLD_TO_PARTY  = V_RADRESSNR4.
<font color ="#0000FF">*    ZIA_CS_FROM_FTP-SOLD_TO_PARTY  = IT_CS-AUFTRAGGEBER.</font>
      ZIA_CS_FROM_FTP-BILL_TO_PARTY = IT_CS-RADRESSNR.
      ZIA_CS_FROM_FTP-PAYER = IT_CS-DEBITORKONTO.
      DATA:V_RADRESSNR5 TYPE KNA1-KUNNR.
      CLEAR:V_RADRESSNR5.


      IF IT_CS-AUFTRAGSART = '20' OR IT_CS-AUFTRAGSART = '23' OR
         IT_CS-AUFTRAGSART = '24' OR IT_CS-AUFTRAGSART = '26' OR
         IT_CS-AUFTRAGSART = '12' OR IT_CS-AUFTRAGSART = '32' OR
         IT_CS-AUFTRAGSART = '33' OR  IT_CS-AUFTRAGSART = '3'.

        ZIA_CS_FROM_FTP-SHIP_TO_PARTY       = IT_CS-AADRESSNR.             " Sold To party
<font color ="#0000FF">*        ZIA_CS_FROM_FTP-NAME_SHIP_TO_PARTY  = IT_CS-ANAME1.                " Name of solt to party</font>

      ENDIF.
    ENDIF.
<font color ="#0000FF">*    ZIA_CS_FROM_FTP-CUST_PO_DATE</font>
    CLEAR:LWA_PARAM4.
    TRANSLATE IT_CS-GUTSCHRIFTSGRUND TO UPPER CASE.
    CLEAR: LANGTH, POS.
    LANGTH = STRLEN( IT_CS-GUTSCHRIFTSGRUND ).

    DO LANGTH TIMES.

      IF IT_CS-GUTSCHRIFTSGRUND+POS(1) CO '01123456789./'.
        CLEAR IT_CS-GUTSCHRIFTSGRUND+POS(1).
      ENDIF.
      ADD 1 TO POS.
    ENDDO.

    CONDENSE IT_CS-GUTSCHRIFTSGRUND NO-GAPS.

    READ TABLE LT_PARAM4 INTO LWA_PARAM4 WITH KEY TH_PARAM = IT_CS-GUTSCHRIFTSGRUND.
    ZIA_CS_FROM_FTP-REASON_CODE = LWA_PARAM4-SAP_PARAM.

    CLEAR:LWA_PARAM3.
    READ TABLE LT_PARAM3 INTO LWA_PARAM3 WITH KEY TH_PARAM = IT_CS-ZAHLUNGSBED.
    ZIA_CS_FROM_FTP-PAYMENT_TERM        = LWA_PARAM3-SAP_PARAM.                      "Pyament Term

<font color ="#0000FF">*     &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</font>
<font color ="#0000FF">**Added by vaibhav on 19.06.2020 for DE11 PLANT</font>
    IF ZIA_CS_FROM_FTP-DELIVERY_PLANT = 'DE11'.
      IF IT_CS-AUFTRAGSART = '20'.
        IF ZIA_CS_FROM_FTP-REASON_CODE IS INITIAL.
          ZIA_CS_FROM_FTP-REASON_CODE = 'S99'.
        ENDIF.
      ENDIF.

      IF ZIA_CS_FROM_FTP-ORDER_TYPE = 'ZEUC' OR ZIA_CS_FROM_FTP-ORDER_TYPE = 'ZEUD' OR ZIA_CS_FROM_FTP-ORDER_TYPE = 'ZEUR'.
        IF ZIA_CS_FROM_FTP-REASON_CODE IS INITIAL.
          ZIA_CS_FROM_FTP-REASON_CODE = 'S99'.
        ENDIF.
      ENDIF.

      IF IT_CS-AUFTRAGSART = '26'.
        ZIA_CS_FROM_FTP-REASON_CODE = 'LWV'.
      ENDIF.

      IF IT_CS-AUFTRAGSART = '24'.
        ZIA_CS_FROM_FTP-REASON_CODE = 'DE3'.
      ENDIF.

      ZIA_CS_FROM_FTP-ADD_FIELD7 = IT_CS-GUTSCHRIFTSGRUND.    "XML Reason code
      ZIA_CS_FROM_FTP-ADD_FIELD8 = IT_CS-ZAHLUNGSBED.    "XML Payment Term
      ZIA_CS_FROM_FTP-ADD_FIELD9 = IT_CS-KUNDENGRUPPEID. "XML Customer Group

    ENDIF.
<font color ="#0000FF">**   &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</font>

    DATA: P_MATNR  TYPE MARA-MATNR,
          P_MTART  TYPE MARA-MTART,
          P_MEINS  TYPE MARA-MEINS,
          P_MEINS1 TYPE MARA-MEINS.

    ZIA_CS_FROM_FTP-STORAGE_LOCATION    = 'FGST'.
    ZIA_CS_FROM_FTP-MANDT    = SY-MANDT.

    IF IT_CS-AUFTRAGSART = '20' OR IT_CS-AUFTRAGSART = '23' OR
       IT_CS-AUFTRAGSART = '24' OR IT_CS-AUFTRAGSART = '26' OR
       IT_CS-AUFTRAGSART = '12' OR IT_CS-AUFTRAGSART = '32' OR
       IT_CS-AUFTRAGSART = '33' .
      ZIA_CS_FROM_FTP-ADD_FIELD4       = IT_CS-AUFTRAGSART.
    ENDIF.

    "Added by vaibhav on 20.06.2020
    IF ZIA_CS_FROM_FTP-DELIVERY_PLANT = 'DE11'.
      IF IT_CS-AUFTRAGSART = '1' OR IT_CS-AUFTRAGSART = '2' OR
       IT_CS-AUFTRAGSART = '3' OR IT_CS-AUFTRAGSART = '30' OR
       IT_CS-AUFTRAGSART = '31' OR IT_CS-AUFTRAGSART = '34' OR
       IT_CS-AUFTRAGSART = '5' .
        ZIA_CS_FROM_FTP-ADD_FIELD4       = IT_CS-AUFTRAGSART.
      ENDIF.
    ENDIF.

    ZIA_CS_FROM_FTP-CREATED_ON       = SY-DATUM.
    ZIA_CS_FROM_FTP-CREATED_BY       = SY-UNAME.
    ZIA_CS_FROM_FTP-CREATED_AT       = SY-UZEIT.

    LOOP AT TT_CS.

<font color ="#0000FF">*     SELECT SINGLE FGEX FROM ZAN_UPID_LOCSKU INTO V_MATERIAL WHERE LOCALMATNR = TT_CS-PZN AND ( WHPLANT = 'DE11' OR WHPLANT = 'NL13' ).</font>

<font color ="#0000FF">*      LOOP AT IT_ZIA_T_SO_CONF_I INTO WA_ZIA_T_SO_CONF_I WHERE AUFTRAGNR = IT_CS-AUFTRAGSNUMMER AND POSNR = TT_CS-POSNR."WITH KEY AUFTRAGNR = IT_CS-AUFTRAGSNUMMER POSNR = TT_CS-POSNR..</font>

<font color ="#0000FF">**********************************************************************</font>
      CLEAR: V_COUNT, IT_UPID_LOCSKU[].
      SELECT FGEX
             WHPLANT
             LOCALMATNR
             CREATEDON
        FROM ZAN_UPID_LOCSKU
        INTO TABLE IT_UPID_LOCSKU
        WHERE LOCALMATNR = TT_CS-PZN
<font color ="#0000FF">*          AND ( WHPLANT = 'DE11' OR WHPLANT = 'NL13' ).</font>
         AND WHPLANT = P_PLANT.

      V_COUNT = LINES( IT_UPID_LOCSKU ).

      IF V_COUNT = 1.

        CLEAR: WA_UPID_LOCSKU.
        READ TABLE IT_UPID_LOCSKU INTO WA_UPID_LOCSKU INDEX 1.
        IF SY-SUBRC = 0.
          V_MATERIAL = WA_UPID_LOCSKU-FGEX.
        ENDIF.

      ELSEIF V_COUNT = 0.

        ZIA_PILOG-DOC_NO        = IT_CS-AUFTRAGSNUMMER.
        ZIA_PILOG-TX_DATE       = LV_TR_DATE.
        ZIA_PILOG-REFERENCE_NO  = TT_CS-EXTBESTNR.
        ZIA_PILOG-PLANT         = P_PLANT.
        ZIA_PILOG-STATUS        = 'E'.
        ZIA_PILOG-CREATED_ON    = SY-DATUM.
        ZIA_PILOG-TIME          = SY-UZEIT.
        ZIA_PILOG-CREATED_BY    = SY-UNAME.

        SELECT SINGLE MAX( SR_NO ) FROM ZIA_PILOG INTO LV_SRNO.
<font color ="#0000FF">*</font>
        LV_SRNO = LV_SRNO + 1.
        ZIA_PILOG-SR_NO = LV_SRNO.
        CONCATENATE 'FGEX code does not exists for VNR code' TT_CS-PZN
                                                             INTO ZIA_PILOG-MESSAGE
                                                             SEPARATED BY ''.
        INSERT ZIA_PILOG.
        COMMIT WORK.

      ELSE.

        CLEAR: V_COUNT, IT_MCHA[].
        IF TT_CS-CHARGENNAME IS NOT INITIAL.

          SELECT MATNR
                 WERKS
                 CHARG FROM MCHB
                       INTO TABLE IT_MCHA
                       FOR ALL ENTRIES IN IT_UPID_LOCSKU
                       WHERE MATNR = IT_UPID_LOCSKU-FGEX
<font color ="#0000FF">*                           AND ( WERKS = 'DE11' OR WERKS = 'NL13' )</font>
                         AND WERKS = P_PLANT
                         AND CHARG = TT_CS-CHARGENNAME
                         AND ( CLABS &gt; 0 OR CINSM &gt; 0 OR CSPEM &gt; 0 ).

          V_COUNT = LINES( IT_MCHA ).

          IF V_COUNT = 1.

            CLEAR: WA_MCHA, V_COUNT.
            READ TABLE IT_MCHA INTO WA_MCHA INDEX 1.
            IF SY-SUBRC = 0.
              V_MATERIAL = WA_MCHA-MATNR.
            ENDIF.

          ELSE.

            ZIA_PILOG-DOC_NO        = IT_CS-AUFTRAGSNUMMER.
            ZIA_PILOG-TX_DATE       = LV_TR_DATE.
            ZIA_PILOG-REFERENCE_NO  = TT_CS-EXTBESTNR..
            ZIA_PILOG-PLANT         = P_PLANT.
            ZIA_PILOG-STATUS        = 'E'.
            ZIA_PILOG-CREATED_ON    = SY-DATUM.
            ZIA_PILOG-TIME          = SY-UZEIT.
            ZIA_PILOG-CREATED_BY    = SY-UNAME.

            SELECT SINGLE MAX( SR_NO ) FROM ZIA_PILOG INTO LV_SRNO.
<font color ="#0000FF">*</font>
            LV_SRNO = LV_SRNO + 1.
            ZIA_PILOG-SR_NO = LV_SRNO.
            CONCATENATE 'Multiple FGEX code found for VNR code' TT_CS-PZN 'and Plant' P_PLANT
                                                               INTO ZIA_PILOG-MESSAGE SEPARATED BY SPACE.
            INSERT ZIA_PILOG.
            COMMIT WORK.

          ENDIF.
        ELSE.
          SORT IT_UPID_LOCSKU BY CREATEDON DESCENDING.
          CLEAR: WA_UPID_LOCSKU.
          READ TABLE IT_UPID_LOCSKU INTO WA_UPID_LOCSKU INDEX 1.
          IF SY-SUBRC = 0.
            V_MATERIAL = WA_UPID_LOCSKU-FGEX.
          ENDIF.

        ENDIF.
      ENDIF.
<font color ="#0000FF">**********************************************************************</font>

      ZIA_CS_FROM_FTP-MATNR = V_MATERIAL.

      IF ZIA_CS_FROM_FTP-DELIVERY_PLANT NE 'NL13'.
        ZIA_CS_FROM_FTP-UOM = 'NOS'.
      ELSEIF ZIA_CS_FROM_FTP-DELIVERY_PLANT EQ 'NL13'.
        ZIA_CS_FROM_FTP-UOM = 'PAK'.
      ENDIF.
<font color ="#0000FF">*      ZIA_CS_FROM_FTP-UOM = P_MEINS1.</font>
<font color ="#0000FF">*      LOOP AT IT_ZIA_T_SO_CONF_I INTO WA_ZIA_T_SO_CONF_I WHERE AUFTRAGNR = IT_CS-AUFTRAGSNUMMER AND POSNR = TT_CS-POSNR.</font>

      ZIA_CS_FROM_FTP-VNR_CODE       = TT_CS-PZN.
      ZIA_CS_FROM_FTP-QUANTITY       = TT_CS-CHARGENMENGE.
<font color ="#0000FF">*start of add by masthan dt:16122021 CR#8000004717</font>
      IF P_PLANT = 'DE11'.
        CLEAR: ZIA_CS_FROM_FTP-STORAGE_LOCATION.
        SELECT SINGLE SAP_PARAM  FROM ZIA_FTP
                                 INTO ZIA_CS_FROM_FTP-STORAGE_LOCATION
                                 WHERE PROCESS_TYPE EQ 'DE_STLOC'
<font color ="#0000FF">*                                 AND TH_PARAM EQ IT_CS-BESTANDSTATUS."Commented By Dhara / Mehul on 23.02.2023 Charm No.:8000007190</font>
                                 AND TH_PARAM EQ TT_CS-BESTANDSTATUS. "Added By Dhara / Mehul on 23.02.2023 Charm No.:8000007190
      ENDIF.
<font color ="#0000FF">*end of add by masthan dt:16122021 CR#8000004717</font>
      IF ZIA_CS_FROM_FTP-STORAGE_LOCATION IS INITIAL.
        ZIA_CS_FROM_FTP-STORAGE_LOCATION    = 'FGST'.
      ENDIF.
<font color ="#0000FF">*        ZIA_CS_FROM_FTP-STORAGE_LOCATION = IT_CS-BestandStatus.                   " Customer PO Reference</font>
      ZIA_CS_FROM_FTP-CUST_PO_NO     = TT_CS-EXTBESTNR.                   " Customer PO Reference
      ZIA_CS_FROM_FTP-RATE_TAX1      = TT_CS-VAT.                         " VAT
      ZIA_CS_FROM_FTP-AMOUNT_TAX1    = TT_CS-PREISVORRABATTBRUTTO / 100.  " Price WITH VAT
      ZIA_CS_FROM_FTP-NET_PRICE      = TT_CS-PREISVORRABATT / 100.        " Net Price
      ZIA_CS_FROM_FTP-GROSS_PRICE    = TT_CS-PREISVORRABATT / 100.
      ZIA_CS_FROM_FTP-DISCOUNT       = TT_CS-RABATTINPROZENT.             " Discount In % RABATINPROCENT YDED
      ZIA_CS_FROM_FTP-DISCOUNT_VALUE = TT_CS-RABATT.                      " Discount in C-Cents
<font color ="#0000FF">*      CLEAR:WA_ZIA_T_SO_CONF_I.</font>
      ZIA_CS_FROM_FTP-BATCH = TT_CS-CHARGENNAME.               " Batch

<font color ="#0000FF">*      ZIA_CS_FROM_FTP-SO_LINE_ITEMNO = I_EBELP.</font>
      LV_COUNT = LV_COUNT + 1.
      ZIA_CS_FROM_FTP-SO_LINE_ITEMNO = LV_COUNT * 10.
      ZIA_CS_FROM_FTP-ADD_FIELD6 = TT_CS-POSNR.
      LOOP AT IT_DISC.
        IF IT_DISC-DESIG = 'Frachtkostenanteil'.
          ZIA_CS_FROM_FTP-ADD_FIELD5 = IT_DISC-NETPR.
        ELSE.
          SPLIT IT_DISC-DESIG AT '%' INTO TEXT1 TEXT2.
          ZIA_CS_FROM_FTP-RATE_TAX2 = TEXT1.
          ZIA_CS_FROM_FTP-AMOUNT_TAX2 = IT_DISC-NETPR.
        ENDIF.
      ENDLOOP.
      IF ZIA_CS_FROM_FTP-DELIVERY_PLANT NE 'NL13'.
        ZIA_CS_FROM_FTP-SALES_GROUP = 'DE1'.
        ZIA_CS_FROM_FTP-SALES_OFFICE = 'DE10'.
      ELSEIF ZIA_CS_FROM_FTP-DELIVERY_PLANT EQ 'NL13'.
        ZIA_CS_FROM_FTP-SALES_GROUP = 'NL1'.
        ZIA_CS_FROM_FTP-SALES_OFFICE = 'NL10'.
      ENDIF.
      INSERT ZIA_CS_FROM_FTP.
      COMMIT WORK.
<font color ="#0000FF">*      ENDLOOP.</font>

      IF SY-SUBRC &lt;&gt; 0.
        ZIA_CS_FROM_FTP-MATNR = V_MATERIAL.

<font color ="#0000FF">*      CLEAR:P_MATNR,P_MTART,P_MEINS,P_MEINS1.</font>
<font color ="#0000FF">*      SELECT SINGLE MATNR MTART MEINS FROM MARA INTO (P_MATNR ,P_MTART,P_MEINS) WHERE MATNR = V_MATERIAL.</font>
<font color ="#0000FF">*      IF P_MTART = 'FGEX' OR P_MTART = 'AUFG' OR P_MTART = 'ZFRT' OR  P_MTART = 'HAWA'.</font>
<font color ="#0000FF">*        P_MEINS1 = 'PAK'.</font>
<font color ="#0000FF">*      ELSE.</font>
<font color ="#0000FF">*        P_MEINS1 = P_MEINS.</font>
<font color ="#0000FF">*      ENDIF.</font>
        IF ZIA_CS_FROM_FTP-DELIVERY_PLANT NE 'NL13'.
          ZIA_CS_FROM_FTP-UOM = 'NOS'.
        ELSEIF ZIA_CS_FROM_FTP-DELIVERY_PLANT EQ 'NL13'.
          ZIA_CS_FROM_FTP-UOM = 'PAK'.
        ENDIF.
<font color ="#0000FF">*      ZIA_CS_FROM_FTP-UOM = P_MEINS1.</font>
        ZIA_CS_FROM_FTP-VNR_CODE       = TT_CS-PZN.
        ZIA_CS_FROM_FTP-QUANTITY       = TT_CS-MENGE.
        ZIA_CS_FROM_FTP-CUST_PO_NO     = TT_CS-EXTBESTNR.                       " Customer PO Reference
        ZIA_CS_FROM_FTP-RATE_TAX1      = TT_CS-VAT.                             " VAT
        ZIA_CS_FROM_FTP-AMOUNT_TAX1    = TT_CS-PREISVORRABATTBRUTTO / 100.      " Price With VAT
        ZIA_CS_FROM_FTP-NET_PRICE      = TT_CS-PREISVORRABATT / 100.            " Net Price
        ZIA_CS_FROM_FTP-GROSS_PRICE    = TT_CS-PREISVORRABATT / 100.
        ZIA_CS_FROM_FTP-DISCOUNT       = TT_CS-RABATTINPROZENT.                 " Discount In % RABATINPROCENT YDED
        ZIA_CS_FROM_FTP-DISCOUNT_VALUE = TT_CS-RABATT.                          " Discount in C-Cents

<font color ="#0000FF">*      ZIA_CS_FROM_FTP-SO_LINE_ITEMNO = I_EBELP.</font>
        LV_COUNT = LV_COUNT + 1.
        ZIA_CS_FROM_FTP-SO_LINE_ITEMNO = LV_COUNT * 10.
        ZIA_CS_FROM_FTP-ADD_FIELD6 = TT_CS-POSNR.
        LOOP AT IT_DISC.
          IF IT_DISC-DESIG = 'Frachtkostenanteil'.
            ZIA_CS_FROM_FTP-ADD_FIELD5 = IT_DISC-NETPR.
          ELSE.
            SPLIT IT_DISC-DESIG AT '%' INTO TEXT1 TEXT2.
            ZIA_CS_FROM_FTP-RATE_TAX2 = TEXT1.
            ZIA_CS_FROM_FTP-AMOUNT_TAX2 = IT_DISC-NETPR.
          ENDIF.
        ENDLOOP.

        IF ZIA_CS_FROM_FTP-DELIVERY_PLANT NE 'NL13'.
          ZIA_CS_FROM_FTP-SALES_GROUP = 'DE1'.
          ZIA_CS_FROM_FTP-SALES_OFFICE = 'DE10'.
        ELSEIF ZIA_CS_FROM_FTP-DELIVERY_PLANT EQ 'NL13'.
          ZIA_CS_FROM_FTP-SALES_GROUP = 'NL1'.
          ZIA_CS_FROM_FTP-SALES_OFFICE = 'NL10'.
        ENDIF.
        INSERT ZIA_CS_FROM_FTP.
        COMMIT WORK.
      ENDIF.
    ENDLOOP.
    COMMIT WORK.
    CLEAR: LV_COUNT.

  ENDLOOP.

ENDFUNCTION.
</pre>
<hr>
<font size="2" face = "Sans Serif">Extracted by Direct Download Enterprise version 1.3.1 - E.G.Mellodew. 1998-2005 UK. Sap Release 750
</font>
</body>
</html>
